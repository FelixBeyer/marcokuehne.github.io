---
title: "Data Scraping II"
subtitle: "Sentiment Analysis of Students Tripadvisor Reviews"
author: "Marco KÃ¼hne"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document: default
---

# Goal

Web-scrape (download) all reviews on the Berlin Global exhibition. In order to conduct webscraping you need to understand the structure of the html elements and website structure. One URL is for the exhibition (shows 10 reviews):

<https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-Berlin_Global-Berlin.html>
<https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-or10-Berlin_Global-Berlin.html>
<https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-or20-Berlin_Global-Berlin.html>
<https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-or30-Berlin_Global-Berlin.html>
<https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-or40-Berlin_Global-Berlin.html>

A single review can be found here:

<https://www.tripadvisor.de/ShowUserReviews-g187323-d23632357-r846481095-Berlin_Global-Berlin.html>

In this case, I decided to scrape 
<!-- https://datamathstat.wordpress.com/2018/01/21/web-scraping-using-r-tripadvisor-example/ -->
<!-- https://gist.github.com/praneethsaiii/ff0cd5cb72037492e3557919e9f360c2 -->
<!-- https://www.cahoover.com/blog/marketing-analytics/scraping-tripadvisor-reviews-using-r/ -->

# RSelenium

## Start Browser 

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE}
library('DT')
library('tidyverse')
library('RSelenium')
# 4449L can use almost any port
# cannot use 2 port twice
rD <- rsDriver(port = 4887L, browser = c("firefox")) 
remDr <- rD[["client"]]
```

## Navigate to Page 

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE}
remDr$navigate("https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-Berlin_Global-Berlin.html")
Sys.sleep(5)
```

## Accept cookies 

Find out CSS or xpath to the accept bottom. 

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE}
# #onetrust-accept-btn-handler
# //*[(@id = "onetrust-accept-btn-handler")]
webElems <- remDr$findElements(using = "css", "#onetrust-accept-btn-handler")

# We can check if we did get the proper button by checking the text of the element:
unlist(lapply(webElems, function(x) {x$getElementText()}))

# We found the two button, and we want to click the first one:
webElems[[1]]$clickElement()
```

## Download html 

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE}
library(rvest)

html <- remDr$getPageSource()[[1]]
html <- read_html(html)
``` 

## Extract Authors

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE}
authors <- html %>% # Name a variable reviews and take a look at the html
  html_elements(".zpDvc") %>% 
  html_text() %>% 
  as_tibble()

#gsub("\\D+","", authors$value) # numbers
authors$value <- gsub("\\d+.*","", authors$value) # numbers and everything after
```

## Extract Reviews

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE}
# .wnNQG some other elements
# .KxBGd contains reviews and other stuff
# .yCeTE headlines and reviews

reviews <- html %>% # Name a variable reviews and take a look at the html
  html_elements(".yCeTE") %>% # In particular, look at the class named .cPQsENeY / yCeTE / yCeTE / biGQs _P pZUbB KxBGd
  html_text() %>% # Grab the text contained with this class .yCeTE 
  as_tibble() # And save it as a tibble to reviews.

# Extract headlines
headlines <- reviews %>%
 slice(which(row_number() %% 2 == 1)) # nice modulo operation 

# Extract text
texts <- reviews %>%
 slice(which(row_number() %% 2 == 0))
```

## Combine Data (2 pt)

Create a dataframe for all tripadvisor reviews that contain information about the author, title and review text. 

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE}
tripadvisor <- data.frame(author = authors$value,
                          title = headlines,
                          text = texts)

colnames(tripadvisor) <- c("Author", "Title", "Text")
```


<!-- ## Loop all Reviews -->

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
library(rvest)

# Initialize Dataframe
tripadvisor <- data.frame(Author = character(),
                          Title = character(),
                          Text = character(),
                          stringsAsFactors=FALSE) 

for (i in c("", "or10-", "or20-", "or30-", "or40-")) {
  
  # Navigate each page
  remDr$navigate(paste0("https://www.tripadvisor.de/Attraction_Review-g187323-d23632357-Reviews-", i, "Berlin_Global-Berlin.html"))
  
  # Download html
  html <- remDr$getPageSource()[[1]]
  html <- read_html(html)
  
  # Extract Authors
  authors <- html %>% # Name a variable reviews and take a look at the html
    html_elements(".zpDvc") %>% 
    html_text() %>% 
    as_tibble() %>% 
    mutate(value = gsub("\\d+.*","", value))
  # Extract Title
  reviews <- html %>% # Name a variable reviews and take a look at the html
    html_elements(".yCeTE") %>% # In particular, look at the class named .cPQsENeY / yCeTE / yCeTE / biGQs _P pZUbB KxBGd
    html_text() %>% 
    as_tibble() 
  # Extract headlines
  titles <- reviews %>%
    slice(which(row_number() %% 2 == 1))
  # Extract text
  texts <- reviews %>%
    slice(which(row_number() %% 2 == 0))
  # Combine data
  mydata <- data.frame(Author = authors$value,
                       Title = titles$value,
                       Text = texts$value)
  # Row bind each iteration
  tripadvisor <- rbind(tripadvisor, mydata)

  Sys.sleep(5)
  
}

#glimpse(tripadvisor)
```

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE}
library(DT)
datatable(tripadvisor)
```

# Text Preparation

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE}
library(tidytext)

# text cleaning
clean_text <- function(x) {
  x %>%
    # Remove digits
    str_remove_all("[:digit:]") %>%
    # Remove punctuation
    str_remove_all("[[:punct:]]") %>%
    # Make everything lowercase
    str_to_lower() %>%
    # Remove any trailing whitespace around the text
    str_trim("both")
}

tripadvisor$Text_Clean <- clean_text(tripadvisor$Text)
datatable(tripadvisor)

# tidy text format for all text
tidytext <- tripadvisor %>%
  unnest_tokens(word, Text_Clean) %>%
  count(word, sort=TRUE)
#head(tidytext)

# tidy text per use
tidy_reviews <- tripadvisor %>%
  group_by(Author) %>%
  unnest_tokens(word, Text_Clean)

# stopwords
data(stop_words)

tidytext <- tidytext %>%
  anti_join(stop_words)
#head(tidytext)
# 
# # Sentiment with Tidy Text
# nrc_joy <- get_sentiments("nrc") %>% 
#   filter(sentiment == "joy")
# 
# tidytext %>%
#   #filter(book == "Emma") %>%
#   inner_join(nrc_joy) %>%
#   count(word, sort = TRUE)
```

# Sentiment Analysis 

The `sentimentr` package offers several options to analyse sentiments at the sentence or aggregate level. A description can be found on GitHub <https://github.com/trinker/sentimentr>. 

## Aggregate Level (1 pt)

The aggregate level summarizes all text information by author into one text block. The `sentiment()` function displays the total word count and an overall sentiment score (the higher the more positive). 

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
library(sentimentr)
library(magrittr)
library(dplyr)

head(sentiment(tripadvisor$Text_Clean), n=15)
```

## Sentence Level (2 pt)

Create a table from all reviews such that each sentence per person is a row. Use `get_sentences()` from the `sentimentr` package. It returns a list object. Find a way to unlist and collect the information in a dataframe. 

```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
sentences <- get_sentences(tripadvisor$Text)

sentence_level <- data.frame(id = character(),
                             sentence = character(),
                             stringsAsFactors=FALSE) 

for (i in 1:nrow(tripadvisor)) {
  # Create data frame for 1 person all sentences
  tmp <- as.data.frame(sentences[i], col.names = "sentence") %>%
  mutate(id = i)
  # Row bind each iteration
  sentence_level <- rbind(sentence_level, tmp)
}

datatable(sentence_level)

# Yeah
sentence_level %>%
    mutate(review = get_sentences(sentence)) %$%
    sentiment_by(sentence, id) %>%
    highlight()
```

![](polarity.png)








