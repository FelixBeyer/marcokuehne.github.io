# Linear Regression 

Please create a R markdown script and name it `R08_name.Rmd` replacing `name` by your name. Follow the structure of this document. 

- Start each section with the appropriate heading by using a hashtag as first symbol. 
- The final `R08_name.html` document is supposed to show code and its result. 
- Hide warnings and messages. Make it clean and concise. 

When you are done, knit your document in order to create a HTML file. Name it `R08_name.html` replacing name by your name. Upload `R08_name.Rmd` and `R08_name.html`. 

## Data Inspection

Load `soep.dta` file from our learning management platform. 

```{r, eval=TRUE, echo=FALSE}
setwd("C:/Users/Marco2020/Dropbox/Viadrina/2022 SS/Seminar in Applied Economics/R08 Linear Regression")
```

```{r, eval=TRUE, echo=TRUE}
library(haven)
master <- read_dta("master.dta")
```

<!-- Use `SOEPhelp` to find useful variables (only very few variables have speaking labels, e.g. `height`). -->

Inspect the data with `glimpse`() in the console. Are there any missing? Ask `table(is.na(master))`. 

```{r, warnings=FALSE, message=FALSE}
library(tidyverse)
glimpse(master)
```

## Data Manipulation (2 pt)

Please do the following:

-   Filter for positive values in `height` and `weight`.
-   Filter for the `year` equal to 2016.
-   Create a variable `female` which is 1 for females and 0 for males (i.e. dummy variable).
-   Create a variable `age` as a difference of current survey year and birth year.
-   Rename the state and region variable (use `state` and `region` instead of SOEP code).

Hint: Check <https://paneldata.org/> for the meaning of `pla0009_v2`, `ple0010_h`, `l11101` and `l11102`.

Only keep the 8 variables you see in via the `glimpse()` function. Your `soep` sample should exactly look like this:

```{r, warning=FALSE, message=FALSE, echo=TRUE, eval=TRUE}
library(tidyverse)
soep <- master %>%
  filter(height > 0, weight > 0) %>%
  filter(syear == 2016) %>%
  mutate(female = as_factor(ifelse(pla0009_v2 == 1, 0, 1))) %>%
  mutate(age = 2016 - ple0010_h) %>%
  rename(state = l11101,
         region = l11102) %>%
  select(!c("ple0010_h", "pla0009_v2"))
```

```{r, warning=FALSE, message=FALSE}
glimpse(soep)
```

## Data Visualization (2 pt)

Please create a scatterplot of weight by height (both numeric/continuous variables) colored by gender. Add one linear regression line per gender (a regression per subgroup).

```{r, echo=TRUE, eval=TRUE, out.width = '80%', fig.align="center", message=FALSE}
library(ggplot2)

# Scatterplot (2 numeric/continuous variables by 1 categorical/group)
# This is like two scatterplots drawn in one graph.
ggplot(soep, aes(x=height, y=weight, color=female)) +
  geom_point() +
  geom_smooth(aes(group=female), method="lm", size=2, se=FALSE) +
  labs(title = "A scatterplot of two continuous variables.",
       subtitle = "Independent regression line for each group.")
```

The relationship looks slightly different. The line is flatter for females. Female data seems to be clustered at the lower left, whereas males are on average at the upper right part of the data cloud. 

Please create a scatterplot of weight by height and depict each group in a single graph (side-by-side).

```{r, echo=FALSE, eval=TRUE, out.width = '80%', fig.align="center", message=FALSE}
# Scatterplot (2 numerics separated by group)
ggplot(soep, aes(x=height, y=weight)) +
  geom_point() +
  geom_smooth(method="lm", size=2, se=FALSE) +
  facet_wrap(.~female) +
  labs(title = "A scatterplot of two continuous variables.",
       subtitle = "Independent plot with regression line for each group.")

# Correlation by group
# gp = group_by(soep, female)
# dplyr::summarize(gp, cor(height, weight))
```


## Simplest Regression (2 pt)

The simplest regression or empty model does not contain any explanatory variable.

```{r, include=TRUE, message=FALSE}
simplest <- lm(weight ~ 1, data=soep)
simplest
```

<!-- mean(soep$weight) -->

Please create the graphs below. With help help of package `gridExtra` the `grid.arrange()` function can do the job. The left panel shows the grand mean (red) for all observations. The second panel shows the grand mean (this time black) as well as the two group means by gender (red and blue).

```{r, echo=TRUE, eval=TRUE, out.width = '100%', fig.align="center", message=FALSE, warning=FALSE}
require(gridExtra)

# Plot overall intercept
plot1 <- ggplot() +
  geom_point(data=soep, aes(x=1:nrow(soep), y=weight)) +
  geom_hline(yintercept = mean(soep$weight), color="red", size=2) +
  labs(title="Intercept model of weight", caption="SOEP Teaching Sample v36")

# Plot intercept by group
means_by_gender <- soep %>% group_by(female) %>% summarise(mean_weight = mean(weight))

plot2 <- ggplot(data=soep, aes(x=1:nrow(soep), y=weight, color=female)) +
  geom_point() +
  geom_hline(yintercept = mean(soep$weight), color="black", size=1.5) +
  geom_hline(data = means_by_gender, aes(yintercept = mean_weight, col = female), size=2) +
  labs(title="Intercept model of weight", subtitle="Grand mean (black) and group means",
       caption ="SOEP Teaching Sample v36")

grid.arrange(plot1, plot2, ncol=2)
```

## Simple Regression

### X is continuous (1 pt)

```{r, include=TRUE, message=FALSE}
simple1 <- lm(weight ~ height, data=soep)
simple1
```

Marco is approximately 1.85m tall. Please calculate his expected weight in kg according to model `simple1`. Hint: Please access and use the model components like `coefficients` as in `simple1$coefficients` in order to solve the task.

`simple1$coefficients[1] + simple1$coefficients[2] * 185 = 82.50118`    

```{r, message=FALSE, warning=FALSE, echo=FALSE, eval=FALSE}
# Scatterplot (2 numeric/continuous variables)
ggplot(soep, aes(x=height, y=weight)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(title="Simple Regression of Weight vs. Height",
       caption ="SOEP Teaching Sample v36") +
  geom_point(aes(x=185,y=90), 
             color='red',
             size=3, show.legend = TRUE) + 
  geom_label(aes(x=185,y=90, label = "Marco prediction"), size=3,
             hjust = 0, vjust =  "inward",
             nudge_x = 0.05, nudge_y = 2,
             label.padding = unit(0.3, "lines")) +
  geom_point(aes(x=185,y=80), 
             color='green',
             size=3) +
  geom_label(aes(x=185,y=80, label = "Marco reality"), size=3,
             hjust = 0, vjust =  "inward",
             nudge_x = 0.15, nudge_y = -2,
             label.padding = unit(0.3, "lines")) 

# # Scatterplot (2 numeric/continuous variables) + color the group
# ggplot(soep, aes(x=height, y=weight)) +
#   geom_point(aes(color=female)) +
#   geom_smooth(method="lm") +
#   labs(title="Simple Regression of Weight vs. Height",
#        subtitle="Coloured by Gender",
#        caption ="SOEP Teaching Sample of 2016")
```

### X is a dummy (1 pt)

```{r, include=TRUE, message=FALSE}
simple2 <- lm(weight ~ female, data=soep)
simple2
```

Marco is male. Please calculate his expected weight in kg according to model `simple2`. Hint: Please access and use the model components like `coefficients` as in `simple2$coefficients` in order to solve the task.

`simple2$coefficients[1] = 85.85999` 

### X is categorical (1 pt)
<!-- https://moderndive.com/6-multiple-regression.html#model4interactiontable -->

Select all states in East Germany. Filter the `region` variable appropriately. Store the new data as `east`.

Variable `state` contains all 16 states of Germany. Whereas `female` is already recognized as a factor variable (`fct`), state is classified as a double with labels (`dbl+lbl`), i.e. R assumes `state` is a continuous variable between 1 and 16.

Convert `state` to factor. Use `mutate` and `as_factor` on the `state` variable. Set the levels of this factor variable to official state abbreviations, i.e. `"BE", "BB", "MV", "SN", "ST", "TH"` by setting  `levels(east$state)` equal to the list of abbreviations.

```{r, warning=FALSE, message=FALSE, echo=TRUE, eval=TRUE}
east <- soep %>%
  filter(region == 2) %>%
  mutate(state = as_factor(state))

east$state <- factor(east$state)
levels(east$state) <- c("BE", "BB", "MV", "SN", "ST", "TH")
```

Run regression with categorical variable `state` on the `east` sample. The output should look like this:

```{r, warning=FALSE, message=FALSE}
simple3 <- lm(weight ~ state, data=east)
simple3
```

## Parallel Slopes

### X is continuous + dummy (1 pt)

Please replicate the following plot. 

```{r, warning=FALSE, message=FALSE, echo=TRUE, eval=TRUE}
# Plot Parallel Slopes Model by Package
library(moderndive)
ggplot(soep, aes(x=height, y=weight, color=female)) +
  geom_point() +
  geom_parallel_slopes(se=FALSE, size=2) +
  labs(title="Scatter plot of weight by height with parallel slopes",
       caption ="SOEP Teaching Sample v36")
```

Bonus. Marco is male and about 185cm. 

```{r, warning=FALSE, message=FALSE}
parallel1 <- lm(weight ~ height + female, data=soep)
parallel1
```

Please calculate his expected weight in kg according to model `parallel1`. Please access and use the model components like `coefficients` as in `parallel1$coefficients` in order to solve the task.

` parallel1$coefficients[1] + 185 * parallel1$coefficients[2] = 90.55837`


